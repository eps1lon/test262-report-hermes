name: test262
on:
  - workflow_dispatch
  - push
env:
  DEBUG: "this:*"
  HERMES_RELEASE: RNv0.71.0
jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: true
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: yarn install --immutable --immutable-cache
      - name: Run test262
        env:
          TEST_PATTERN: "test262/test/**/*.js"
        run: |
          # --threads matches (v)CPUs available on the machine
          # See https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#supported-runners-and-hardware-resources
          yarn test262-harness \
            --host-type hermes \
            --host-path "hermes-releases/$HERMES_RELEASE/hermes" \
            --preprocessor scripts/test/eshostPreprocessor.js \
            --reporter json \
            --reporter-keys result,relative,attrs.features,scenario \
            --test262-dir test262 \
            --threads 2 \
            --timeout 60000 \
            "$TEST_PATTERN" > test262-report.${{matrix.shard}}.json
      - name: Archive test262 report
        uses: actions/upload-artifact@v3
        with:
          name: test262-report-${{matrix.shard}}
          path: test262-report.${{matrix.shard}}.json
  postprocess:
    runs-on: ubuntu-22.04
    needs: test
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
          submodules: false
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: yarn install --immutable --immutable-cache

      - name: Download test262 report shards
        id: download-shards
        uses: actions/download-artifact@v3
        with:
          path: test262-report-shards
      - name: Postprocess shards
        run: node scripts/test/reportPostprocess.js ${{steps.download-shards.outputs.download-path}} "hermes-releases/$HERMES_RELEASE/report"
      - name: Archive processed test262 report
        uses: actions/upload-artifact@v3
        with:
          name: report
          path: hermes-releases/${{env.HERMES_RELEASE}}/report
      - name: Display report diff
        run: git diff -- hermes-releases/${{env.HERMES_RELEASE}}/report
